<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Header -->
    {% include 'html/header.html' %}
</head>

<body>

    <!-- SideNavbar -->
    {% include 'html/sidenav.html' %}

    <!-- HTML Templates for KPI Trends and Bar Graphs -->
    <!-- See "kpi_ajax()" below for context -->
    <div class="hide-template">
        <div id="bar-template">
            <h3 id="tname"></h3>
            <img id="tgraph" style="width: 100%; height: auto;">
        </div>

        <div id="trend-template">
            <div class="d-flex justify-content-between align-items-center kpi-img">
                <div id="kpi-name" style="width: 25%;">
                    <p></p>
                </div>
                <div id="kpi-change" class="d-flex align-items-center justify-content-center"
                    style="width: 25%; gap: 10px;"><i id="kpi-arrow"></i></div>
                <div style="width: 50%;">
                    <img id="kpi-graph">
                    <div class="d-flex justify-content-between align-items-center">
                        <p id="kpi-date-1"></p>
                        <p id="kpi-date-2"></p>
                    </div>
                </div>
            </div>
            <hr>
        </div>

        <div id="z-template">
            <h3 id="zname"></h3>
            <img id="zgraph" style="width: 100%; height: auto;">
        </div>
    </div>

    <main class="py-3 py-override">
        <div class="container" style="max-width: 1800px;">
            <div class="row">
                <div class="col-lg-5 overflow-scroll col-padding">
                    <div class="col-scroll">

                        <!-- Athlete Info/Header -->
                        <div class="main-header justify-content-between" style="position: sticky; top:0; z-index: 2;">
                            <div class="d-flex align-items-center" style="gap: 15px;">
                                <h1>{{ athleteProf.fname }} {{ athleteProf.lname }}</h1>
                            </div>
                            <div class="justify-content-between">
                                <label for="id_image">
                                    <i class="fa-solid fa-camera"
                                        style="color: var(--acc-color-main); font-size: var(--icon-size); cursor: pointer;"></i>
                                </label>
                                &nbsp;
                                <a
                                    href="{% url 'EditAthlete' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}">
                                    <i class="fa-solid fa-pen"
                                        style="color: var(--acc-color-main); font-size: var(--icon-size);"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Hidden Input Field to change an image -->
                        <form method="post" enctype="multipart/form-data" style="display: none;" id="imgForm">
                            {% csrf_token %}
                            {{ form.image }}
                        </form>

                        <div class="d-flex">

                            {% if athleteProf.image == '' %}
                            <img class="athlete-pic" src="/media/placeholder.jpg" id="profileImg"></img>
                            {% elif athleteProf.image %}
                            <img class="athlete-pic" src="/media/{{ athleteProf.image }}" id="profileImg"></img>
                            {% endif %}

                            <div class="w-100" style="margin-left: var(--inner-padding);">
                                <div class="d-flex justify-content-between">
                                    <h6>Sport</h6>
                                    <h6 class="text-end">{{ athleteProf.sportsteam }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Position</h6>
                                    <h6 class="text-end">{{ athleteProf.position }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Year</h6>
                                    <h6 class="text-end">{{ athleteProf.year }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Height</h6>
                                    <h6 class="text-end">{{ athleteProf.height }}"</h6>
                                </div>
                            </div>
                        </div>

                        <!-- KPI/Wellness Tabs-->
                        <div class="d-flex" style="margin-top: var(--inner-padding);">
                            <button id="kpi-tab" class="report-tab">KPI</button>
                            <button id="wellness-tab" class="report-tab">Wellness</button>
                        </div>

                        <!-- KPI Trends -->
                        <div id="kpireport" class="report tab-corner bottom-margin">

                            <div class="d-flex justify-content-between align-items-center">
                                <div style="width: 50%">
                                    <h3>KPI Trends</h3>
                                </div>
                                <div class="d-flex justify-content-between" style="width: 50%;">
                                    <p style="font-size: 16px" id="resultone"></p>
                                    <p style="font-size: 16px" id="resulttwo"></p>
                                </div>
                            </div>
                            <hr>

                            <!-- This is where graphs will populate -->
                            <div id="kpi-trend">
                                <p id="no-data" style="margin-bottom: 0;">No data</p>
                            </div>

                            <a href="{% url 'AddKPI' athleteProf.fname athleteProf.lname athleteProf.dob %}">
                                <button class="spanning-button" style="margin-top: var(--inner-padding);">KPI History</button>
                            </a>

                        </div>

                        <div id="wellnessreport" class="report tab-corner" style="display: none;">

                            <!-- Wellness Header & Date Selector -->
                            <div class="d-flex justify-content-between">
                                <h3>Wellness</h3>
                                <form method="post" id="wellnessform">
                                    {% csrf_token %}
                                    <div class="d-flex justify-content-between">
                                        <select id="wellnessdate" name="wellnessdate">
                                            <option selected>{{ mostRecentWellnessReportDate }}</option>
                                            {% for x in wellnessReportDates %}
                                            <option>{{ x.date }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </form>
                            </div>

                            <!-- Wellness Display -->
                            <div style="margin-top: var(--inner-padding);">
                                <div class="d-flex">
                                    <div id="stat-box" class="w-100 wellness-status-display"
                                        style="margin-right: calc(var(--inner-padding)/2);">
                                        <div class="d-flex justify-content-center">
                                            <h4 id="stat">None</h4>
                                        </div>
                                    </div>
                                    <div class="w-100 wellness-status-display"
                                        style="margin-left: calc(var(--inner-padding)/2); border: 1px solid white;">
                                        <div class="d-flex justify-content-center">
                                            <h4 id="total">None</h4>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: var(--inner-padding);">
                                    <table class="table wellness-table"
                                        style="border-color: rgba(255, 255, 255, 0.321); color: white;">
                                        <tr>
                                            <td>
                                                <h6>Hours of Sleep</h6>
                                                <h6 id="hrs_sleep"></h6>
                                            </td>
                                            <td>
                                                <h6>Sleep Quality</h6>
                                                <h6 id="sleep_qual"></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <h6>Breakfast</h6>
                                                <h6 id="breakfast"></h6>
                                            </td>
                                            <td>
                                                <h6>Hydration</h6>
                                                <h6 id="hydration"></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <h6>Soreness</h6>
                                                <h6 id="soreness"></h6>
                                            </td>
                                            <td>
                                                <h6>Stress</h6>
                                                <h6 id="stress"></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="border-bottom: none;">
                                                <h6>Mood</h6>
                                                <h6 id="mood"></h6>
                                            </td>
                                            <td style="border-bottom: none;">
                                                <h6><strong>Total</strong></h6>
                                                <h6 id="wellness_total"></h6>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <a href="{% url 'AddWellness' athleteProf.fname athleteProf.lname athleteProf.dob %}">
                                <button class="spanning-button" style="margin-top: 20px;">Add Wellness Report</button>
                            </a>

                        </div>
                    </div>
                </div>

                <div class="col-lg-7 overflow-scroll col-padding">
                    <div class="col-scroll">

                        <!-- Date Selector + Settings-->
                        <div class="main-header justify-content-between" style="padding-top: var(--inner-padding)">
                            <form method="post" id="kpiform" name="kpiform">
                                {% csrf_token %}
                                <div id="kpi-dates-div">
                                    <select id="date1" name="date1" style="font-size:20px;">
                                        <option selected>{{ kpi_earliest }}</option>
                                        {% for x in all_dates %}
                                        <option>{{ x.datekpi }}</option>
                                        {% endfor %}
                                    </select>
                                    to
                                    <select id="date2" name="date2" style="font-size:20px;">
                                        <option selected>{{ kpi_most_recent }}</option>
                                        {% for x in all_dates %}
                                        <option>{{ x.datekpi }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="spider-date-div" style="display: none;">
                                    <select id="spider_date" name="spider_date" style="font-size:20px;">
                                        <option selected>{{ kpi_most_recent }}</option>
                                        {% for x in all_dates %}
                                        <option>{{ x.datekpi }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                            <div class="d-flex align-items-center" style="gap:var(--inner-padding); margin-top: 8px;">
                                <!-- Bar/Spider Chart Tabs-->
                                <div class="d-flex h-100">
                                    <button id="bar-tab" class="report-tab">
                                        <i class="fa-solid fa-chart-simple" style="color: var(--acc-color-main); font-size: var(--icon-size);""></i>
                                    </button>
                                    <button id="spider-tab" class="report-tab">
                                        <i class="fa-solid fa-spider" style="color: var(--acc-color-main); font-size: var(--icon-size);"></i>
                                    </button>
                                    <!--<button id="z-scores-tab" class="report-tab">T-Scores</button>-->
                                </div>
                                <i class="fa-solid fa-gear" id="settings"
                                    style="color: var(--acc-color-main); font-size: var(--icon-size); z-index: 2;"></i>

                                <div id="options-card" class="options-card overflow-scroll" style="display: none;">
                                    <h4>Settings</h4>
                                    <div id="raw-score-selections">
                                        <ul>
                                            <li>Bar Graph Selections:</li>
                                            </li>
                                            <li>Team Avg<input class="check_box" id="t_AVG" type="checkbox" name="t_avg" value="1">
                                            </li>
                                            <li>Gender Avg<input class="check_box" id="g_AVG" type="checkbox" name="g_avg" value="1">
                                            </li>
                                            <li>Position Avg<input class="check_box" id="p_AVG" type="checkbox" name="p_avg" value="1"></li>
                                        </ul>
                                    </div>
                                    <div id="t-score-selections">
                                        <ul>
                                            <li>T-Score Selections:</li>
                                            </li>
                                            <li>Team Avg<input class="radioBTN" id="teamAVG" type="radio" name="z_avg" value="1" checked="true">
                                            </li>
                                            <li>Gender Avg<input class="radioBTN" id="genderAVG" type="radio" name="z_avg" value="2">
                                            </li>
                                            <li>Position Avg<input class="radioBTN" id="positionAVG" type="radio" name="z_avg" value="3"></li>
                                        </ul>
                                    </div>
                                    <hr>
                                    <ul id="test-list"></ul>
                                </div>
                            </div>
                        </div>

                        <script>
                            //jQuery for functionality of "tabs"
                            $(document).ready(function () {

                                //initially hide wellness report and show only kpi trends
                                $("#wellnessreport").hide();
                                document.getElementById("wellness-tab").style.backgroundColor = "var(--color-bg)";

                                //initially hide spider graph, only show bar graph to begin with
                                $("#bar-graphs").show();
                                document.getElementById("spider-tab").style.backgroundColor = "var(--color-bg)";

                                // initially show raw scores options in options card (since this will be the graphs that are shown first)
                                $("#t-score-graphs").hide();
                                $("#raw-score-graphs").show();

                                $("#raw-score-selections").show();
                                $("#t-score-selections").hide();

                                //upon click of wellness tab, show wellnessreport div & hide kpireport div
                                //swap color of tab
                                $("#wellness-tab").click(function () {
                                    $("#kpireport").hide();
                                    $("#wellnessreport").show();
                                    document.getElementById("wellness-tab").style.backgroundColor = "var(--color-secondary)";
                                    document.getElementById("kpi-tab").style.backgroundColor = "var(--color-bg)";
                                });

                                //upon click of kpi tab, show kpireport div & hide wellnessreport div
                                //swap color of tab
                                $("#kpi-tab").click(function () {
                                    $("#kpireport").show();
                                    $("#wellnessreport").hide();
                                    $("#spider-date-div").hide();
                                    $("#kpi-dates-div").show();
                                    document.getElementById("kpi-tab").style.backgroundColor = "var(--color-secondary)";
                                    document.getElementById("wellness-tab").style.backgroundColor = "var(--color-bg)";
                                });

                                //upon click of spider-tab, show spider-graphs div & hide bar-graph div
                                //swap color of tab
                                $("#spider-tab").click(function () {
                                    $("#bar-graphs").hide();
                                    $("#spider-graphs").show();
                                    $("#spider-date-div").show();
                                    $("#kpi-dates-div").hide();
                                    document.getElementById("spider-tab").style.backgroundColor = "var(--color-secondary)";
                                    document.getElementById("bar-tab").style.backgroundColor = "var(--color-bg)";

                                    $("#t-score-selections").hide();
                                    $("#raw-score-selections").hide();
                                });

                                //upon click of bar-tab, show bar-graph  div & hide spider-graphs div
                                //swap color of tab
                                $("#bar-tab").click(function () {
                                    $("#spider-graphs").hide();
                                    $("#bar-graphs").show();
                                    $("#spider-date-div").hide();
                                    $("#kpi-dates-div").show();
                                    document.getElementById("bar-tab").style.backgroundColor = "var(--color-secondary)";
                                    document.getElementById("spider-tab").style.backgroundColor = "var(--color-bg)";

                                    $("#raw-score-selections").show();
                                    $("#t-score-selections").hide();
                                });

                                $("#t-score-radio").click(function () {
                                    $("#t-score-graphs").show();
                                    $("#raw-score-graphs").hide();

                                    $("#raw-score-selections").hide();
                                    $("#t-score-selections").show();
                                });

                                $("#raw-score-radio").click(function () {
                                    $("#raw-score-graphs").show();
                                    $("#t-score-graphs").hide();
                                    
                                    $("#raw-score-selections").show();
                                    $("#t-score-selections").hide();
                                });

                                // upon click of cog wheel "settings", show the options card
                                // if it's already showing, close it. functions as a toggle
                                $("#settings").click(function () {
                                    if ($('#options-card').is(':hidden')) {
                                        $("#options-card").show();
                                    } else {
                                        $("#options-card").hide();
                                    }

                                });
                            });
                        </script>

                        <div id="z-scores" class="graphprof">
                            <p style="margin-bottom: 0; align-self: center;">No data</p>
                        </div>

                        <!-- Spider Chart -->
                        <div id="spider-graphs" class="graphprof">
                            <form method="post" id="kpi_spider_form">
                                {% csrf_token %}
                                <form method="post" >
                                    {% csrf_token %}
                                    <!-- Checkboxes to select tests -->
                                    <div id="selected_spider_tests">
                                        {% for test in all_tests %}
                                        <input type="checkbox" id="{{ test }}" name="selected_spider_tests" value="{{ test }}">
                                        <label for="{{ test }}">{{ test }}</label><br>
                                        {% endfor %}
                                    </div>
                                    <hr>
                                    <!-- Checkboxes to select comparison averages -->
                                    <div id="spider-avgs"> 
                                        <input type="checkbox" id="team_avg" name="compare_avg" value="team_avg">
                                        <label for="team_avg">Team Avg</label><br>
                                        <input type="checkbox" id="position_avg" name="compare_avg" value="position_avg">
                                        <label for="position_avg">Position Avg</label><br>
                                        <input type="checkbox" id="gender_avg" name="compare_avg" value="gender_avg">
                                        <label for="gender_avg">Gender Avg</label><br>
                                        <br>
                                        <input type="submit" id="spider-submit" class="submit">
                                    </div>
                                </form>
                            </form>

                            <!-- JavaScript for the spider chart -->
                            <script>
                                /* getCookie() function definition*/
                                // Definition for "getCookie" function, which will return a cookie from the document matching the parameter "name".
                                // This is a utility funciton utilized to send and AJAX request (see next code block)

                                // Cookie is initialized to null
                                // If there is are document cookies and they are NOT empty, the cookies in the document are fetched and placed in an array
                                // This array is searched for a cookie that matches parameter "name"
                                // If such a cookie is found, it is returned.
                                function getCookie(name) {
                                    let cookieValue = null;
                                    if (document.cookie && document.cookie !== "") {
                                        const cookies = document.cookie.split(";");
                                        for (let i = 0; i < cookies.length; i++) {
                                            const cookie = cookies[i].trim();
                                            // Does this cookie string begin with the name we want?
                                            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                break;
                                            }
                                        }
                                    }
                                    return cookieValue;
                                }

                                // Call the spider_ajax function when the submit button is clicked
                                document.getElementById("spider-submit").addEventListener("click", spider_ajax, false);
                                function spider_ajax(event) {
                                    event.preventDefault();

                                    // Values to be passed to backend
                                    const spider_date = document.getElementById("spider_date").value;
                                    const test_selection = document.getElementById("selected_spider_tests");
                                    const avg_selection = document.getElementById("spider-avgs");

                                    // Select checkboxes 
                                    const t_checkboxes = test_selection.querySelectorAll('input[type="checkbox"]');
                                    const a_checkboxes = avg_selection.querySelectorAll('input[type="checkbox"]');

                                    // Filter the checkboxes to only include those that are checked
                                    const t_checked = Array.from(t_checkboxes ).filter(checkbox => checkbox.checked);
                                    const a_checked = Array.from(a_checkboxes).filter(checkbox => checkbox.checked);
  
                                    // Get the values of the checked checkboxes
                                    const selected_tests = t_checked.map(checkbox => checkbox.value);
                                    const selected_avgs = a_checked.map(checkbox => checkbox.value);

                                    $.ajax({
                                        url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}",
                                        type: "POST",
                                        dataType: "json",
                                        data: JSON.stringify({ "spider_date": spider_date, "selected_spider_tests": selected_tests, "compare_avg": selected_avgs }),
                                        headers: {
                                            "X-Requested-With": "XMLHttpRequest",
                                            "X-CSRFToken": getCookie("csrftoken"),
                                        },
                                        success: (response) => {
                                            // Call the spider chart function to display the chart
                                            spider_chart(response.athlete_spider_results, response.average_spider_results, response.spider_date);
                                        }
                                    })
                                }

                                function spider_chart(athlete_results, average_results, date) {
                                    // Create arrays for the test names and results
                                    var test_names = Object.keys(athlete_results);
                                    var athlete_results_arr = Object.values(athlete_results);

                                    // Create an array of average group names
                                    var group_names = average_results.map(function(group_dict) {
                                        return group_dict.group;
                                    });

                                    // Create an array of arrays of average group results
                                    var group_results_arr = average_results.map(function(group_dict) {
                                        return Object.values(group_dict.results);
                                    });

                                    // Create the spider chart with Plotly
                                    var data = [{
                                        type: 'scatterpolar',
                                        r: athlete_results_arr, // Define the radius values for each data point
                                        theta: test_names, // Define the angle values for each data point
                                        fill: 'toself', // Fill the area enclosed by each data point's line
                                        name: 'Athlete', // Assign a label to this data series
                                        line: {
                                            color: '#96b7ff', // Set the color of the line connecting each data point
                                            width: 2 // Set the width of the line
                                        },
                                        // Customize the tooltip displayed when hovering over each data point
                                        hovertemplate: '<b>Result:</b> %{r}<br><b>Test Type:</b> %{theta}<extra></extra>'
                                    }];

                                    // Colors for team, position, and gender respectively
                                    var average_colors = ['green', 'yellow', 'purple'];
                                    var color_index = 0;
                                    for (var i = 0; i < group_names.length; i++) {
                                        // Add a trace for the group to the spider chart
                                        data.push({
                                            type: 'scatterpolar',
                                            r: group_results_arr[i],
                                            theta: test_names,
                                            fill: 'toself',
                                            name: group_names[i],
                                            line: {
                                                color: average_colors[color_index],
                                                width: 2
                                            },
                                            // Customize the hover over info for each data point  
                                            hovertemplate: '<b>Result:</b> %{r}<br><b>Test Type:</b> %{theta}<extra></extra>'
                                        });
                                        // The next trace will have a new color
                                        color_index += 1;
                                        if (color_index >= average_colors.length) {
                                            color_index = 0;
                                        }
                                    }

                                    // Update the layout of the chart
                                    var layout = {
                                        // Set the graph size, title text, font color, and size
                                        width: '100%',
                                        height: 620,
                                        title: {
                                        text: 'Results for ' + date,
                                        font: {
                                            color: '#ffffff',
                                            size: 24
                                        },
                                        // Set the position of the title
                                        x: 0.005,
                                        y: 0.95
                                        },
                                        // Set the background color of the plot
                                        paper_bgcolor: '#1d1f26',
                                        // Update the styling of the radial axis
                                        polar: {
                                            // Set the background color of the circular chart
                                            bgcolor: '#1d1f26',
                                            radialaxis: {
                                                // Set the font color of the radial axis labels
                                                tickfont: {
                                                color: '#ffffff'
                                                }
                                            },
                                            // Update the styling of the angular axis
                                            angularaxis: {
                                                // Set the font color of the angular axis labels
                                                tickfont: {
                                                color: '#ffffff'
                                                }
                                            }
                                        }
                                    };

                                    // Display the chart
                                    Plotly.newPlot('spider-graphs', data, layout);
                                }
                            </script>
                        </div>

                        <!-- This is where bar graphs will populate -->
                        <div id="bar-graphs" class="graphprof">
                            <div class="btn-container">
                                <div class="btn-group rt-toggle" role="group" aria-label="Basic radio toggle button group">
                                    <input type="radio" class="btn-check" name="btnradio" id="t-score-radio" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="t-score-radio">T</label>
                                
                                    <input type="radio" class="btn-check" name="btnradio" id="raw-score-radio" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="raw-score-radio">R</label>
                                </div>
                            </div>
                            <div id="raw-score-graphs">
                                <p id="no-data" style="margin-bottom: 0; align-self: center;">No data</p>
                            </div>
                            <div id="t-score-graphs">
                                <p id="no-data" style="margin-bottom: 0; align-self: center;">No data</p>
                            </div>
                        </div>

                        <script>

                            //on window load, call ajax to populate page with data
                            window.onload = function () {

                                //if there are kpis or wellness reports, submit an ajax request to get data on page load
                                var kpi_count = "{{ kpi_count }}";
                                var wellness_count = "{{ wellness_count }}";

                                if (kpi_count > 0)
                                    kpi_ajax();
                                if (wellness_count > 0)
                                    wellness_ajax();

                                // if a date selector changes, call ajax to update the page
                                document.getElementById("date1").addEventListener("change", kpi_ajax);
                                document.getElementById("date2").addEventListener("change", kpi_ajax);

                                document.getElementById("t_AVG").addEventListener("click", kpi_ajax);
                                document.getElementById("g_AVG").addEventListener("click", kpi_ajax);
                                document.getElementById("p_AVG").addEventListener("click", kpi_ajax);

                                document.getElementById("teamAVG").addEventListener("click", kpi_ajax);
                                document.getElementById("genderAVG").addEventListener("click", kpi_ajax);
                                document.getElementById("positionAVG").addEventListener("click", kpi_ajax);

                                //if a date selector changes, call ajax to update the page 
                                document.getElementById("wellnessdate").addEventListener("change", wellness_ajax);

                                // if img upload changes... 
                                document.getElementById("id_image").addEventListener("change", imgChange);

                                //set dates on kpi-report div to the ones initially selected
                                document.getElementById("resultone").innerHTML = "{{ kpi_earliest }}";
                                document.getElementById("resulttwo").innerHTML = "{{ kpi_most_recent }}";
                            }

                            /* getCookie() function definition*/
                            // Definition for "getCookie" function, which will return a cookie from the document matching the parameter "name".
                            // This is a utility funciton utilized to send and AJAX request (see next code block)

                            // Cookie is initialized to null
                            // If there is are document cookies and they are NOT empty, the cookies in the document are fetched and placed in an array
                            // This array is searched for a cookie that matches parameter "name"
                            // If such a cookie is found, it is returned.
                            function getCookie(name) {
                                let cookieValue = null;
                                if (document.cookie && document.cookie !== "") {
                                    const cookies = document.cookie.split(";");
                                    for (let i = 0; i < cookies.length; i++) {
                                        const cookie = cookies[i].trim();
                                        // Does this cookie string begin with the name we want?
                                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                            break;
                                        }
                                    }
                                }
                                return cookieValue;

                            }

                            // stops form from resubmitting when page is refreshed to show 
                            if (window.history.replaceState) {
                                window.history.replaceState(null, null, window.location.href);
                            }

                            // submit the form to change database, and refresh the page to show new profile image       
                            function imgChange() {
                                document.getElementById("imgForm").submit();
                                document.getElementById("imgForm").reset();
                            }

                            // hides/shows tests when their corresponding checkmark in the options tab is checked/unchecked
                            function hide_tests() {
                                document.querySelectorAll("[type=checkbox]").forEach(checkbox => {
                                    checkbox.addEventListener("click", function (e) {

                                        // get id of this checkbox
                                        id = this.id;
                                        console.log(id);
                                        if (this.checked) {

                                            // concatenate respective ids of bar and trend graphs
                                            $("#bar_"+id).show();
                                            $("#trend_"+id).show();
                                            $("#z_"+id).show();
                                        }
                                        else {
                                            // concatenate respective ids of bar and trend graphs
                                            $("#bar_"+id).hide();
                                            $("#trend_"+id).hide();
                                            $("#z_"+id).hide();
                                        }
                                        e.stopPropagation();
                                    })
                                })
                            }

                            // global variables to create a lockout when an AJAX request has been made
                            // ensures multiple AJAX requests can't be sent at the same time, which would 
                            // result in jumbled data
                            let is_loading_kpi = false;
                            let is_loading_wellness = false;

                            //grabs info from the database without refreshing page and screwing everything up
                            function kpi_ajax() {

                                if (!is_loading_kpi) {

                                    // Get check box values for bar graph averages
                                    var T_AVG_BTN = $("#t_AVG:checked").val()
                                    var G_AVG_BTN = $("#g_AVG:checked").val()
                                    var P_AVG_BTN = $("#p_AVG:checked").val()

                                    // Get radio button values for z-score graph varients
                                    var AVG_Radio_BTN = $(".radioBTN:checked").val();

                                    // AJAX function has been called! No other calls can be made until this one finishes
                                    is_loading_kpi = true;

                                    // get dates from selectors
                                    var date_one = document.getElementById("date1")
                                    var date_two = document.getElementById("date2")

                                    resultone.innerText = date_one.options[date_one.selectedIndex].text;
                                    resulttwo.innerText = date_two.options[date_two.selectedIndex].text;

                                    // clear trends and graphs 
                                    $("#kpi-trend").empty()
                                    $("#raw-score-graphs").empty()
                                    $("#t-score-graphs").empty()
                                    $("#test-list").empty()

                                    // add loading circle
                                    $("#kpi-trend").append("<div id=\"loading-line\" class=\"d-flex justify-content-center\"> <div class=\"lds-dual-ring\"></div></div>");
                                    $("#bar-graphs").append("<div id=\"loading-bar\" class=\"d-flex justify-content-center\"> <div class=\"lds-dual-ring\"></div></div>");
                                    //$("#z-scores").append("<div id=\"loading-z\" class=\"d-flex justify-content-center\"> <div class=\"lds-dual-ring\"></div></div>");

                                    $.ajax({
                                        url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}",
                                        type: "POST",
                                        dataType: "json",
                                        data: JSON.stringify({ 
                                            date1: date_one.value, 
                                            date2: date_two.value, 
                                            T_AVG_BTN: T_AVG_BTN,
                                            G_AVG_BTN: G_AVG_BTN,
                                            P_AVG_BTN: P_AVG_BTN,
                                            AVG_Radio_BTN: AVG_Radio_BTN,
                                        }),
                                        headers: {
                                            "X-Requested-With": "XMLHttpRequest",
                                            "X-CSRFToken": getCookie("csrftoken"),
                                        },
                                        success: (response) => {

                                            //shows info being passed from backend
                                            console.log(response);

                                            //remove loading circle after info arrives from db
                                            $("#loading-line").remove()
                                            $("#loading-bar").remove()
                                            //$("#loading-z").remove()

                                            //loop thru each test type and get its info
                                            for (var key in response.test_types) {

                                                let bar_template = document.getElementById("bar-template").cloneNode(true);
                                                let trend_template = document.getElementById("trend-template").cloneNode(true);
                                                let z_template = document.getElementById("z-template").cloneNode(true);

                                                // If the change is increasing
                                                if (response.changes[key] > 0) {
                                                    // If a minimum score is better for a test, the change is increasing and is red
                                                    if (response.minBetter[key] === true)
                                                        trend_template.querySelector("#kpi-change").style.color = "var(--acc-color-neg)";
                                                    // If a minimum score is NOT better for a test, the change is increasing and is green
                                                    else if (response.minBetter[key] === false)
                                                        trend_template.querySelector("#kpi-change").style.color = "var(--acc-color-pos)";

                                                    // Add correctly oriented arrow icon
                                                    trend_template.querySelector("#kpi-arrow").setAttribute("class", "fa-solid fa-arrow-up");
                                                }
                                                // If the change is decreasing
                                                else if (response.changes[key] < 0) {
                                                    // If a minimum score is better for a test, the change is decreasing and is green
                                                    if (response.minBetter[key] === true)
                                                        trend_template.querySelector("#kpi-change").style.color = "var(--acc-color-pos)";
                                                    // If a minimum score is NOT better for a test, the change is decreasing and is red
                                                    else if (response.minBetter[key] === false)
                                                        trend_template.querySelector("#kpi-change").style.color = "var(--acc-color-neg)";

                                                    // Add correctly oriented arrow icon
                                                    trend_template.querySelector("#kpi-arrow").setAttribute("class", "fa-solid fa-arrow-down");
                                                }

                                                // Append the actual change value (in absolute form so there is no -)
                                                trend_template.querySelector("#kpi-change").append(Math.abs(response.changes[key]));

                                                // Construct URL for line graph and add path to this node's img tag
                                                var line_graphURL = "data:image/png;base64, " + response.kpi_line[key];
                                                trend_template.querySelector("#kpi-graph").setAttribute("src", line_graphURL);

                                                // Fill in name and dates for this KPI trend
                                                trend_template.querySelector("#kpi-name").innerText = response.test_types[key];
                                                trend_template.querySelector("#kpi-date-1").innerText = response.Date1_results[key];
                                                trend_template.querySelector("#kpi-date-2").innerText = response.Date2_results[key];

                                                // Construct URL for bar graph and add path to this node's img tag
                                                var bar_graphURL = "data:image/png;base64, " + response.kpi_bar[key];
                                                bar_template.querySelector("#tname").innerText = response.test_types[key];
                                                bar_template.querySelector("#tgraph").setAttribute("src", bar_graphURL);

                                                // Construct URL for z-score graph and add path to this node's img tag
                                                var z_graphURL = "data:image/png;base64, " + response.z_score_bar[key];
                                                z_template.querySelector("#zname").innerText = response.test_types[key];
                                                z_template.querySelector("#zgraph").setAttribute("src", z_graphURL);

                                                // Give both graphs for each type an integer ID that will allow them to be maniuplated later
                                                trend_template.setAttribute("id", "trend_" + key);
                                                bar_template.setAttribute("id", "bar_" + key);
                                                z_template.setAttribute("id", "z_" + key);

                                                // Add this completed graph template to the div containing all graphs
                                                $("#kpi-trend").append(trend_template);
                                                //$("#kpi-trend").append("<hr>");
                                                $("#raw-score-graphs").append(bar_template);
                                                $("#t-score-graphs").append(z_template);

                                                var checkid = /*"check_" +*/ key;

                                                document.getElementById("test-list").innerHTML += "<li>" + response.test_types[key] + "<input type=\"checkbox\" id=\"" + checkid + "\" checked=\"true\"></li>";

                                                //document.getElementById(checkid).addEventListener("change", function() { update_graph_display(key) });
                                            }
                                            hide_tests();
                                            // AJAX call is done, so another one can go
                                            is_loading_kpi = false;
                                        },
                                        error: (error) => {
                                            console.log("Error processing KPI request: " + error);

                                            // AJAX call is done, so another one can go
                                            is_loading_kpi = false;
                                        }
                                    })
                                }
                                else
                                    alert("Dates changed too quickly! Please wait for this request to finish and try again.");
                            }

                            /* When the "#wellnessform" form is submitted, this function will send an AJAX request to fetch the new data. */
                            function wellness_ajax() {

                                if (!is_loading_wellness) {

                                    is_loading_wellness = true;

                                    // Get value of #sportsteam
                                    var date_selected = document.getElementById("wellnessdate").value

                                    // Send "POST" AJAX request to url 'AthleteProf'
                                    // This request will be handled by the Django backend -> see views.py recordKPI() for that code
                                    $.ajax({
                                        //URL needs to be fname, lname, DOB for athletes
                                        url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}",
                                        type: "POST",
                                        dataType: "json",
                                        data: JSON.stringify({ wellnessdate: date_selected, }),
                                        headers: {
                                            "X-Requested-With": "XMLHttpRequest",
                                            "X-CSRFToken": getCookie("csrftoken"),  // don't forget to include the 'getCookie' function
                                        },
                                        success: (response) => {

                                            console.log(response);

                                            // Get individual values needed for wellness total and then sum them
                                            var hoursofsleep = Number(response.wellness[0].hoursofsleep);
                                            var sleepquality = Number(response.wellness[0].sleepquality);
                                            var breakfast = Number(response.wellness[0].breakfast);
                                            var hydration = Number(response.wellness[0].hydration);
                                            var soreness = Number(response.wellness[0].soreness);
                                            var stress = Number(response.wellness[0].stress);
                                            var mood = Number(response.wellness[0].mood);

                                            document.getElementById("hrs_sleep").innerText = hoursofsleep;
                                            document.getElementById("sleep_qual").innerText = sleepquality;
                                            document.getElementById("breakfast").innerText = breakfast;
                                            document.getElementById("hydration").innerText = hydration;
                                            document.getElementById("soreness").innerText = soreness;
                                            document.getElementById("stress").innerText = stress;
                                            document.getElementById("mood").innerText = mood;

                                            var total = hoursofsleep + sleepquality + breakfast + hydration + soreness + stress + mood;
                                            var status = response.wellness[0].status;

                                            // Update total & readiness in document
                                            document.getElementById("wellness_total").innerText = total;
                                            document.getElementById("stat").innerHTML = status;
                                            document.getElementById("total").innerHTML = "Readiness: " + total;

                                            if (status == "Out") {
                                                document.getElementById("stat-box").style.color = "var(--black-text)";
                                                document.getElementById("stat-box").style.backgroundColor = "var(--acc-color-neg)";
                                            }
                                            else if (status == "Good") {
                                                document.getElementById("stat-box").style.color = "var(--black-text)";
                                                document.getElementById("stat-box").style.backgroundColor = "var(--acc-color-pos)";
                                            }

                                            is_loading_wellness = false;

                                        },
                                        error: (error) => {

                                            console.log(error);
                                            alert("Error processing Wellness request: " + error);
                                            is_loading_wellness = false;
                                        }
                                    })
                                }
                                else
                                    alert("Date changed too quickly! Please wait for this request to finish and try again.");
                            }

                        </script>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

</html>